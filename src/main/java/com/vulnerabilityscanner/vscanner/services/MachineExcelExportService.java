package com.vulnerabilityscanner.vscanner.services;

import com.vulnerabilityscanner.vscanner.entities.Machine;
import com.vulnerabilityscanner.vscanner.entities.MachineArchive;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;

@Service
public class MachineExcelExportService {

    // Constantes de configuration
    private static final int MAX_FILE_SIZE_MB = 10;
    private static final int MAX_ROWS = 100_000;
    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
    private static final DateTimeFormatter DATE_ONLY_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd");
    private static final DateTimeFormatter SHEET_DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss");

    public byte[] generateMachinesReport(List<Machine> activeMachines, List<MachineArchive> archivedMachines) throws IOException {
        validateInput(activeMachines, archivedMachines);

        try (Workbook workbook = new XSSFWorkbook()) {
            // Créer une feuille de métadonnées
            createMetadataSheet(workbook, activeMachines.size(), archivedMachines.size());

            CellStyle headerStyle = createHeaderStyle(workbook);
            createActiveMachinesSheet(workbook, headerStyle, activeMachines);
            createArchivedMachinesSheet(workbook, headerStyle, archivedMachines);

            return writeToByteArray(workbook);
        }
    }

    private void validateInput(List<Machine> activeMachines, List<MachineArchive> archivedMachines) {
        if (activeMachines == null || archivedMachines == null) {
            throw new IllegalArgumentException("Les listes de machines ne peuvent pas être null");
        }

        if (activeMachines.size() + archivedMachines.size() > MAX_ROWS) {
            throw new IllegalArgumentException(
                    String.format("Trop de données à exporter (max %d lignes)", MAX_ROWS));
        }
    }

    private void createMetadataSheet(Workbook workbook, int activeCount, int archivedCount) {
        Sheet metaSheet = workbook.createSheet("Métadonnées");

        // Style pour les titres
        CellStyle titleStyle = workbook.createCellStyle();
        Font titleFont = workbook.createFont();
        titleFont.setBold(true);
        titleFont.setFontHeightInPoints((short)14);
        titleStyle.setFont(titleFont);
        titleStyle.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex());
        titleStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);

        // Style pour les valeurs
        CellStyle valueStyle = workbook.createCellStyle();
        Font valueFont = workbook.createFont();
        valueFont.setFontHeightInPoints((short)12);
        valueStyle.setFont(valueFont);

        // Données de métadonnées
        Object[][] metadata = {
                {"Titre du rapport", "Rapport des machines"},
                {"Date d'exportation", LocalDateTime.now().format(DATE_FORMATTER)},
                {"Exporté par", getCurrentUsername()},
                {"Nombre de machines actives", activeCount},
                {"Nombre de machines archivées", archivedCount},
                {"Total", activeCount + archivedCount}
        };

        // Remplir la feuille de métadonnées
        for (int i = 0; i < metadata.length; i++) {
            Row row = metaSheet.createRow(i);

            Cell titleCell = row.createCell(0);
            titleCell.setCellValue(metadata[i][0].toString());
            titleCell.setCellStyle(titleStyle);

            Cell valueCell = row.createCell(1);
            Object value = metadata[i][1];
            if (value instanceof Number) {
                valueCell.setCellValue(((Number) value).doubleValue());
            } else {
                valueCell.setCellValue(value.toString());
            }
            valueCell.setCellStyle(valueStyle);
        }

        // Ajuster la largeur des colonnes
        metaSheet.autoSizeColumn(0);
        metaSheet.autoSizeColumn(1);
    }

    private String getCurrentUsername() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        return authentication != null ? authentication.getName() : "Système";
    }

    private CellStyle createHeaderStyle(Workbook workbook) {
        CellStyle style = workbook.createCellStyle();
        Font font = workbook.createFont();
        font.setBold(true);
        style.setFont(font);
        style.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex());
        style.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        style.setBorderBottom(BorderStyle.THIN);
        style.setBorderTop(BorderStyle.THIN);
        style.setBorderLeft(BorderStyle.THIN);
        style.setBorderRight(BorderStyle.THIN);
        return style;
    }

    private void createActiveMachinesSheet(Workbook workbook, CellStyle headerStyle, List<Machine> machines) {
        String sheetName = "Actives_" + LocalDateTime.now().format(SHEET_DATE_FORMATTER);
        Sheet sheet = workbook.createSheet(sheetName);

        String[] headers = {
                "ID", "Nom", "Type", "Fabricant", "Modèle",
                "Numéro de série", "Adresse IP", "Adresse MAC",
                "Système d'exploitation", "Processeur",
                "RAM (Go)", "Stockage (Go)",
                "Date d'achat", "Fin de garantie",
                "Localisation", "Description"
        };

        createSheetHeader(sheet, headerStyle, headers);
        fillActiveMachinesData(sheet, machines);
        autoSizeColumns(sheet, headers.length);
    }

    private void createArchivedMachinesSheet(Workbook workbook, CellStyle headerStyle, List<MachineArchive> machines) {
        String sheetName = "Archives_" + LocalDateTime.now().format(SHEET_DATE_FORMATTER);
        Sheet sheet = workbook.createSheet(sheetName);

        String[] headers = {
                "ID Archive", "ID Machine", "Nom", "Type", "Fabricant",
                "Modèle", "Numéro de série", "Adresse IP", "Adresse MAC",
                "Système d'exploitation", "Processeur",
                "RAM (Go)", "Stockage (Go)",
                "Date d'achat", "Fin de garantie",
                "Localisation", "Description",
                "Date archivage", "Type d'action"
        };

        createSheetHeader(sheet, headerStyle, headers);
        fillArchivedMachinesData(sheet, machines);
        autoSizeColumns(sheet, headers.length);
    }

    private void createSheetHeader(Sheet sheet, CellStyle headerStyle, String[] headers) {
        Row headerRow = sheet.createRow(0);
        for (int i = 0; i < headers.length; i++) {
            Cell cell = headerRow.createCell(i);
            cell.setCellValue(headers[i]);
            cell.setCellStyle(headerStyle);
        }
    }

    private void fillActiveMachinesData(Sheet sheet, List<Machine> machines) {
        int rowNum = 1;
        for (Machine machine : machines) {
            Row row = sheet.createRow(rowNum++);

            row.createCell(0).setCellValue(machine.getId());
            row.createCell(1).setCellValue(getSafeString(machine.getName()));
            row.createCell(2).setCellValue(getSafeString(machine.getType()));
            row.createCell(3).setCellValue(getSafeString(machine.getManufacturer()));
            row.createCell(4).setCellValue(getSafeString(machine.getModel()));
            row.createCell(5).setCellValue(getSafeString(machine.getSerialNumber()));
            row.createCell(6).setCellValue(getSafeString(machine.getIpAddress()));
            row.createCell(7).setCellValue(getSafeString(machine.getMacAddress()));
            row.createCell(8).setCellValue(getSafeString(machine.getOperatingSystem()));
            row.createCell(9).setCellValue(getSafeString(machine.getCpu()));
            row.createCell(10).setCellValue(machine.getRamGb());
            row.createCell(11).setCellValue(machine.getStorageGb());
            row.createCell(12).setCellValue(formatDate(machine.getPurchaseDate()));
            row.createCell(13).setCellValue(formatDate(machine.getWarrantyExpiryDate()));
            row.createCell(14).setCellValue(getSafeString(machine.getLocation()));
            row.createCell(15).setCellValue(getSafeString(machine.getDescription()));
        }
    }

    private void fillArchivedMachinesData(Sheet sheet, List<MachineArchive> machines) {
        int rowNum = 1;
        for (MachineArchive machine : machines) {
            Row row = sheet.createRow(rowNum++);

            row.createCell(0).setCellValue(machine.getId());
            row.createCell(1).setCellValue(machine.getMachineId());
            row.createCell(2).setCellValue(getSafeString(machine.getName()));
            row.createCell(3).setCellValue(getSafeString(machine.getType()));
            row.createCell(4).setCellValue(getSafeString(machine.getManufacturer()));
            row.createCell(5).setCellValue(getSafeString(machine.getModel()));
            row.createCell(6).setCellValue(getSafeString(machine.getSerialNumber()));
            row.createCell(7).setCellValue(getSafeString(machine.getIpAddress()));
            row.createCell(8).setCellValue(getSafeString(machine.getMacAddress()));
            row.createCell(9).setCellValue(getSafeString(machine.getOperatingSystem()));
            row.createCell(10).setCellValue(getSafeString(machine.getCpu()));
            row.createCell(11).setCellValue(machine.getRamGb());
            row.createCell(12).setCellValue(machine.getStorageGb());
            row.createCell(13).setCellValue(formatDate(machine.getPurchaseDate()));
            row.createCell(14).setCellValue(formatDate(machine.getWarrantyExpiryDate()));
            row.createCell(15).setCellValue(getSafeString(machine.getLocation()));
            row.createCell(16).setCellValue(getSafeString(machine.getDescription()));
            row.createCell(17).setCellValue(formatDate(machine.getArchivedAt()));
            row.createCell(18).setCellValue(getSafeString(machine.getActionType()));
        }
    }

    private String getSafeString(String value) {
        return value != null ? value : "";
    }

    private String formatDate(Object date) {
        if (date == null) return "";

        if (date instanceof java.time.LocalDateTime) {
            return ((java.time.LocalDateTime) date).format(DATE_FORMATTER);
        } else if (date instanceof java.time.LocalDate) {
            return ((java.time.LocalDate) date).format(DATE_ONLY_FORMATTER);
        }
        return date.toString();
    }

    private void autoSizeColumns(Sheet sheet, int columnCount) {
        for (int i = 0; i < columnCount; i++) {
            sheet.autoSizeColumn(i);
        }
    }

    private byte[] writeToByteArray(Workbook workbook) throws IOException {
        try (ByteArrayOutputStream outputStream = new ByteArrayOutputStream()) {
            workbook.write(outputStream);
            if (outputStream.size() > MAX_FILE_SIZE_MB * 1024 * 1024) {
                throw new IOException(
                        String.format("Le fichier excède la taille maximale de %dMB", MAX_FILE_SIZE_MB));
            }
            return outputStream.toByteArray();
        }
    }
}