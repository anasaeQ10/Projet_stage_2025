package com.vulnerabilityscanner.vscanner.controllers;

import com.vulnerabilityscanner.vscanner.services.StatisticsService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class StatisticsController {

    @Autowired
    private StatisticsService statisticsService;

    @GetMapping("/statistics")
    public String statisticsPage(Model model) {
        // Machines
        model.addAttribute("totalMachines", statisticsService.getTotalMachines());
        model.addAttribute("machinesByType", statisticsService.getMachinesByType());
        model.addAttribute("machinesBySeverity", statisticsService.getMachinesBySeverity());

        // Utilisateurs
        model.addAttribute("totalUsers", statisticsService.getTotalUsers());
        model.addAttribute("adminsCount", statisticsService.getAdminsCount());
        model.addAttribute("normalUsersCount", statisticsService.getNormalUsersCount());

        // Vulnérabilités
        model.addAttribute("totalVulnerabilities", statisticsService.getTotalVulnerabilities());
        model.addAttribute("recentVulnerabilities", statisticsService.getRecentVulnerabilities(10));

        // **Graphiques dynamiques**
        // Exemple : utilisateurs par mois (Map<String, Integer>)
        model.addAttribute("usersByMonth", statisticsService.getUsersByMonth());

        // Machines vulnérables vs sécurisées
        long vulnCount = statisticsService.getMachinesBySeverity().getOrDefault("Securisé", 0L);
        long safeCount = statisticsService.getTotalMachines() - vulnCount;
        model.addAttribute("machinesVulnCounts", java.util.Arrays.asList(vulnCount, safeCount));

        return "admin/statistics";
    }

}
